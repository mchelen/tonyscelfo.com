<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>blog.tonyscelfo.com</title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="tales of a software ninjaneer">

    <link rel="stylesheet" href="/ss/styles.css">
    <link rel="stylesheet" href="/ss/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
      <h1><a href="/">blog.tonyscelfo.com</a></h1>
        <p>tales of a software ninjaneer</p>
        
          <a href="/2010/10/19/2007-subaru-impreza-sti.html">2007 Subaru Impreza STi</a><br />
        
          <a href="/2010/09/19/shared-account-for-repo-hosting.html">Shared Account for Repo Hosting</a><br />
        
          <a href="/2010/09/07/using-git-to-deploy-website.html">Using Git to Deploy a Website</a><br />
        
          <a href="/2010/02/18/use-keyboard-shortcuts-in-google.html">Use Keyboard Shortcuts in Google Applications</a><br />
        
          <a href="/2009/07/29/use-nomachine-free-edition-instead-of.html">Use NoMachine Free Edition Instead of FreeNX</a><br />
        
          <a href="/2009/07/13/use-smarthost-to-route-outgoing-exim4.html">Use Smarthost to Route Outgoing Exim4 Mail Through Gmail</a><br />
        
          <a href="/2009/06/15/freenx-lets-you-use-nomachine-for-free.html">FreeNX lets you use NoMachine for free... and its so nice!!!</a><br />
        
          <a href="/2009/04/27/save-all-of-your-bash-history.html">Save all of your bash history</a><br />
        
          <a href="/2009/04/02/dr-color-chip.html">Dr. ColorChip</a><br />
        
          <a href="/2008/09/25/dont-use-esc-in-vi.html">Don't use the Esc key in Vi</a><br />
        
          <a href="/2008/09/15/hacking-appletv.html">Hacking AppleTV</a><br />
        
          <a href="/2008/08/05/new-homepage-design.html">New Homepage Design</a><br />
        
          <a href="/2005/10/10/huge-arch.html">Huge Arch</a><br />
        
          <a href="/2005/10/10/dinosaur-journey-museum.html">Dinosaur Journey Museum</a><br />
        
          <a href="/2005/10/10/cool-tree.html">Cool Tree</a><br />
        
          <a href="/2005/10/04/open-space-beneath.html">Open space beneath</a><br />
        
          <a href="/2005/10/04/gina-and-kevin.html">Gina and Kevin</a><br />
        
          <a href="/2005/10/03/1989-porsche-944-s2.html">1989 Porsche 944 S2</a><br />
        
        <br />
        <p class="view">
          <a href="https://plus.google.com/110371866564374610674">Google+</a>
          |
          <a href="https://github.com/scelfo">GitHub</a>
          |
          <a href="https://www.facebook.com/tony.scelfo">Facebook</a>
          |
          <a href="http://www.linkedin.com/pub/tony-scelfo/3/8b/b91">LinkedIn</a>
        </p>
      </header>

<section>
<h1>Use Smarthost to Route Outgoing Exim4 Mail Through Gmail</h1>
<p><em>Update 8/27/12</em> - <a href='http://releases.ubuntu.com/12.04/'>Ubuntu 12.04</a> installs postfix by default. If you want to use postfix instead of exim4, follow <a href='http://blog.bigdinosaur.org/postfix-gmail-and-you/'>these instructions</a>. I&#8217;m running 12.04 now and using postfix.</p>

<p>Frustration combined with information found <a href='http://www.glorat.net/2008/11/ubuntu-804-hardy-gmail-smarthost-setup-with-exim4.html'>here</a> inspired this post.</p>

<p>I run an Ubuntu server at home and I have several monitoring tools running to keep an eye on services and hardware. For example: smartd emails me when there are hard drive errors, mdadm emails me when there are raid array problems and monit emails me when services die and get restarted.</p>

<p>Recently, my Ubuntu server hasn&#8217;t been able to send emails to my gmail account. I looked at the <code>/var/log/exim4/mainlog</code> and saw a lot of entries about &#8220;R=dnslookup T=remote_smtp defer (110): Connection timed out&#8221;. The remote SMTP server was failing to validate the hostname of my server, which isn&#8217;t valid outside of my home network. Since I have Comcast at home, there isn&#8217;t any chance that I could get a reverse DNS entry so the best solution is to use Exim4&#8217;s smarthost mail routing feature to route outgoing mail through a gmail account. Google will use the gmail login and password to authenticate my home server and then relay email through Google&#8217;s own SMTP servers.</p>

<p>You could use your own gmail account for routing the email, but if you use <a href='http://www.google.com/a'>Google Apps</a> on your own domain, a better solution is to create a new email account to use for sending mail from your server. This allows you to isolate your automated emails from your primary email account while also protecting your gmail account&#8217;s password. You could use common account names like &#8220;postmaster&#8221; and &#8220;noreply&#8221; or something else that isn&#8217;t likely to get slammed with spam. Gmail will keep a copy of the sent messages in the Sent Mail folder, which is a cool side effect.</p>

<p>Sounds too good to be true? Ready to jump in?</p>

<p>First run <code>sudo dpkg-reconfigure exim4-config</code> and use these config options:</p>

<ul>
<li>
<p>General type of mail configuration: mail sent by smarthost; received via SMTP or fetchmail</p>
</li>

<li>
<p>System mail name: &#60;your hostname&#62;</p>
</li>

<li>
<p>IP-address to listen on for incoming SMTP connections: 127.0.0.1</p>
</li>

<li>
<p>Other destinations for which mail is accepted: &#60;your hostname&#62;</p>
</li>

<li>
<p>Machines to relay mail for: &#60;leave this blank&#62;</p>
</li>

<li>
<p>IP address or host name of the outgoing smarthost: smtp.gmail.com::587</p>
</li>

<li>
<p>Hide local mail name in outgoing mail?</p>

<ul>
<li>Yes - all outgoing mail will appear to come from your gmail account</li>

<li>No - mail sent with a valid sender name header will keep the sender&#8217;s name</li>
</ul>
</li>

<li>
<p>Keep number of DNS-queries minimal (Dial-on-Demand)? No</p>
</li>

<li>
<p>Delivery method for local mail: &#60;choose the one you prefer&#62;</p>
</li>

<li>
<p>Split configuration file into small files? Yes (you need to edit one of the files next)</p>
</li>
</ul>

<p>Then run <code>sudo vi /etc/exim4/passwd.client</code> and add the following lines (substitute &#60;email address&#62; and &#60;password&#62; with the gmail account you want to route mail through):</p>

<pre><code>gmail-smtp.l.google.com:&lt;email address&gt;:&lt;password&gt;
*.google.com:&lt;email address&gt;:&lt;password&gt;
smtp.gmail.com:&lt;email address&gt;:&lt;password&gt;</code></pre>

<p>Once you edit the passwd.client file, run <code>sudo update-exim4.conf</code> which will integrate your changes into your Exim4 config.</p>

<p>Run <code>sudo /etc/init.d/exim4 restart</code> and make sure that the service stops and starts properly. If the service is unable to restart, something probably went wrong when you edited the passwd.client file.</p>

<p>If Exim4 restarted, go ahead and run <code>sudo tail -f /var/log/exim4/mainlog</code> to watch the mail logs. In a different window, send an email from your system and make sure that you see a record go by with <code>R=smarthost T=remote_smtp_smarthost H=gmail-smtp-msa.l.google.com ... X=TLS-1.0:RSA_ARCFOUR_MD5:16</code> in it. The X=TLS means that the mail is being sent with <a href='http://en.wikipedia.org/wiki/Transport_Layer_Security'>transport layer security</a> which is what you want.</p>
</section>
      <footer>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/js/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-3434858-3");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

